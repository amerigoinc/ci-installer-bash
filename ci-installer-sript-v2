#!/bin/bash
# COMPLETE CI Package Manager - Type ANY tool name and it launches
set -e

echo "üåç Installing COMPLETE CI Package Manager..."
echo "üöÄ After install: Type ANY tool name and it launches!"

mkdir -p ~/.ci/{packages,bin,apps,config,temp}

# Create the COMPLETE CI manager
cat > ~/.ci/ci-manager << 'EOF'
#!/bin/bash
CI_DIR="$HOME/.ci"
PACKAGES_DIR="$CI_DIR/packages"
BIN_DIR="$CI_DIR/bin"
APPS_DIR="$CI_DIR/apps"
CONFIG_FILE="$CI_DIR/config/installed.json"
ORG="amerigoinc"

# Create installed packages config
init_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "{}" > "$CONFIG_FILE"
    fi
}

# Universal app launcher creator
create_universal_launcher() {
    local pkg_dir="$1"
    local pkg_name="$2"
    
    if [ ! -f "$pkg_dir/spec.ci" ]; then
        echo "‚ùå No spec.ci found for $pkg_name"
        return 1
    fi

    # Parse spec.ci for app configuration
    local app_name=$(grep -o '"app_name":"[^"]*"' "$pkg_dir/spec.ci" | head -1 | cut -d'"' -f4)
    local launch_cmd=$(grep -o '"launch":"[^"]*"' "$pkg_dir/spec.ci" | head -1 | cut -d'"' -f4)
    local main_file=$(grep -o '"main_file":"[^"]*"' "$pkg_dir/spec.ci" | head -1 | cut -d'"' -f4)
    
    # Default to package name if no app_name specified
    if [ -z "$app_name" ]; then
        app_name="$pkg_name"
    fi
    
    # Default launch command
    if [ -z "$launch_cmd" ]; then
        if [ -n "$main_file" ] && [ -f "$pkg_dir/$main_file" ]; then
            # Detect file type and create appropriate launch command
            case "$main_file" in
                *.py)
                    launch_cmd="python3 $pkg_dir/$main_file"
                    ;;
                *.js)
                    launch_cmd="node $pkg_dir/$main_file"
                    ;;
                *.sh)
                    launch_cmd="bash $pkg_dir/$main_file"
                    ;;
                *.rb)
                    launch_cmd="ruby $pkg_dir/$main_file"
                    ;;
                *.php)
                    launch_cmd="php $pkg_dir/$main_file"
                    ;;
                *.pl)
                    launch_cmd="perl $pkg_dir/$main_file"
                    ;;
                *.java)
                    launch_cmd="java -cp $pkg_dir $pkg_dir/$main_file"
                    ;;
                *)
                    # Binary or unknown - try to execute directly
                    chmod +x "$pkg_dir/$main_file" 2>/dev/null
                    launch_cmd="$pkg_dir/$main_file"
                    ;;
            esac
        else
            # Try to find any executable file
            for file in "$pkg_dir"/*; do
                if [ -f "$file" ] && [ -x "$file" ]; then
                    launch_cmd="$file"
                    break
                fi
            done
            # If still no launch command, use first Python file
            if [ -z "$launch_cmd" ]; then
                local py_file=$(find "$pkg_dir" -name "*.py" -type f | head -1)
                if [ -n "$py_file" ]; then
                    launch_cmd="python3 $py_file"
                fi
            fi
        fi
    fi

    # Create the universal launcher script
    local launcher_file="$APPS_DIR/$app_name"
    
    cat > "$launcher_file" << LAUNCHER
#!/bin/bash
# Universal Launcher for $app_name
# Package: $pkg_name
# Generated by CI Package Manager

cd "$pkg_dir"

# If no launch command could be determined, show error
if [ -z "$launch_cmd" ]; then
    echo "‚ùå No launch configuration found for $app_name"
    echo "üìÅ Package location: $pkg_dir"
    echo "üí° Check the package has a valid spec.ci or executable files"
    exit 1
fi

# Execute the launch command with all arguments
eval "$launch_cmd" "\$@"
LAUNCHER

    chmod +x "$launcher_file"
    
    # Create symlink in bin directory
    ln -sf "$launcher_file" "$BIN_DIR/$app_name"
    
    echo "  üöÄ Created universal command: $app_name"
    echo "  üíª Launch: $launch_cmd"
}

# Install package with universal launcher
install_package() {
    local pkg="$1"
    echo "üîß Installing $pkg from $ORG..."
    
    if ! command -v git >/dev/null; then
        echo "‚ùå Git is required"
        return 1
    fi
    
    local repo_url="https://github.com/$ORG/$pkg.git"
    local pkg_dir="$PACKAGES_DIR/$pkg"
    
    # Remove existing if updating
    if [ -d "$pkg_dir" ]; then
        echo "üîÑ Updating existing package..."
        rm -rf "$pkg_dir"
    fi
    
    echo "üì• Cloning $repo_url..."
    if git clone "$repo_url" "$pkg_dir" 2>/dev/null; then
        echo "‚úÖ Successfully cloned"
        
        # Create universal launcher
        if create_universal_launcher "$pkg_dir" "$pkg"; then
            # Register in config
            init_config
            local timestamp=$(date -Iseconds)
            jq --arg pkg "$pkg" --arg path "$pkg_dir" --arg time "$timestamp" \
               '. + {($pkg): {"path": $path, "installed": $time}}' \
               "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
            
            echo "üéâ $pkg installed successfully!"
            echo "üöÄ You can now type: $pkg"
        else
            echo "‚ùå Failed to create launcher for $pkg"
            rm -rf "$pkg_dir"
            return 1
        fi
    else
        echo "‚ùå Failed to clone $pkg"
        echo "   Check: https://github.com/$ORG/$pkg"
        return 1
    fi
}

# List all available commands
list_commands() {
    echo "üöÄ AVAILABLE COMMANDS:"
    echo "======================"
    
    if [ ! -d "$PACKAGES_DIR" ] || [ -z "$(ls -A $PACKAGES_DIR)" ]; then
        echo "No packages installed yet."
        echo ""
        echo "To get started:"
        echo "  ci install <package-name>"
        return
    fi
    
    for pkg in "$PACKAGES_DIR"/*; do
        if [ -d "$pkg" ]; then
            pkg_name=$(basename "$pkg")
            
            # Get the actual command name from the app launcher
            local app_name="$pkg_name"
            if [ -f "$pkg/spec.ci" ]; then
                local spec_app_name=$(grep -o '"app_name":"[^"]*"' "$pkg/spec.ci" | head -1 | cut -d'"' -f4)
                if [ -n "$spec_app_name" ]; then
                    app_name="$spec_app_name"
                fi
            fi
            
            # Check if launcher exists
            if [ -f "$BIN_DIR/$app_name" ]; then
                echo "üíª $app_name"
                
                # Show description if available
                if [ -f "$pkg/spec.ci" ]; then
                    local desc=$(grep -o '"description":"[^"]*"' "$pkg/spec.ci" | head -1 | cut -d'"' -f4)
                    if [ -n "$desc" ]; then
                        echo "   üìù $desc"
                    fi
                fi
                
                # Show package location
                echo "   üìÅ Package: $pkg_name"
                echo ""
            fi
        fi
    done
}

# Remove package
remove_package() {
    local pkg="$1"
    local pkg_dir="$PACKAGES_DIR/$pkg"
    
    if [ ! -d "$pkg_dir" ]; then
        echo "‚ùå Package $pkg not found"
        return 1
    fi
    
    echo "üóëÔ∏è Removing $pkg..."
    
    # Find and remove the app launcher
    local app_name="$pkg"
    if [ -f "$pkg_dir/spec.ci" ]; then
        local spec_app_name=$(grep -o '"app_name":"[^"]*"' "$pkg_dir/spec.ci" | head -1 | cut -d'"' -f4)
        if [ -n "$spec_app_name" ]; then
            app_name="$spec_app_name"
        fi
    fi
    
    # Remove launcher and symlink
    rm -f "$APPS_DIR/$app_name" 2>/dev/null
    rm -f "$BIN_DIR/$app_name" 2>/dev/null
    
    # Remove package directory
    rm -rf "$pkg_dir"
    
    # Remove from config
    if [ -f "$CONFIG_FILE" ]; then
        jq "del(.\"$pkg\")" "$CONFIG_FILE" > "$CONFIG_FILE.tmp" 2>/dev/null && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
    fi
    
    echo "‚úÖ $pkg removed successfully!"
}

# Update package
update_package() {
    local pkg="$1"
    echo "üîÑ Updating $pkg..."
    
    # Reinstall to update
    if install_package "$pkg"; then
        echo "‚úÖ $pkg updated successfully!"
    else
        echo "‚ùå Failed to update $pkg"
    fi
}

# Show system status
show_status() {
    echo "üîß CI Package Manager Status"
    echo "=========================="
    echo "Version: Complete Universal Launcher"
    echo "Organization: $ORG"
    echo "Commands directory: $BIN_DIR"
    echo "Packages directory: $PACKAGES_DIR"
    echo ""
    
    local pkg_count=0
    local cmd_count=0
    
    if [ -d "$PACKAGES_DIR" ]; then
        pkg_count=$(find "$PACKAGES_DIR" -maxdepth 1 -type d | tail -n +2 | wc -l)
    fi
    
    if [ -d "$BIN_DIR" ]; then
        cmd_count=$(find "$BIN_DIR" -maxdepth 1 -type l | wc -l)
    fi
    
    echo "üì¶ Packages installed: $pkg_count"
    echo "üöÄ Commands available: $cmd_count"
    echo ""
    echo "üí° Type any installed package name to launch it!"
}

# Main command handler
case "$1" in
    install)
        if [ -z "$2" ]; then
            echo "‚ùå Usage: ci install <package-name>"
            exit 1
        fi
        install_package "$2"
        ;;
    remove)
        if [ -z "$2" ]; then
            echo "‚ùå Usage: ci remove <package-name>"
            exit 1
        fi
        remove_package "$2"
        ;;
    update)
        if [ -z "$2" ]; then
            echo "‚ùå Usage: ci update <package-name>"
            exit 1
        fi
        update_package "$2"
        ;;
    list)
        list_commands
        ;;
    status)
        show_status
        ;;
    help|--help|-h)
        echo "üåç CI Package Manager - Universal Launcher"
        echo "Usage: ci <command> [package]"
        echo ""
        echo "Commands:"
        echo "  install <package>  Install and create universal launcher"
        echo "  remove <package>   Remove package and launcher"
        echo "  update <package>   Update package"
        echo "  list              Show all available commands"
        echo "  status            Show system status"
        echo "  help              Show this help"
        echo ""
        echo "Examples:"
        echo "  ci install hello-world    # Install package"
        echo "  hello-world               # Type the name to launch!"
        echo "  ci list                   # See all commands"
        echo ""
        echo "üåü After installation, just type the package name to run it!"
        ;;
    *)
        echo "‚ùå Unknown command: $1"
        echo "üí° Use: ci help"
        ;;
esac
EOF

chmod +x ~/.ci/ci-manager

# Install system-wide
mkdir -p ~/.local/bin
ln -sf ~/.ci/ci-manager ~/.local/bin/ci

# Ensure jq is available for JSON processing
if ! command -v jq >/dev/null 2>&1; then
    echo "üì¶ Installing jq for JSON processing..."
    if command -v apt-get >/dev/null 2>&1; then
        sudo apt-get update && sudo apt-get install -y jq
    elif command -v yum >/dev/null 2>&1; then
        sudo yum install -y jq
    elif command -v brew >/dev/null 2>&1; then
        brew install jq
    else
        echo "‚ö†Ô∏è  jq not installed. Some features may not work."
        echo "üí° Install jq manually for full functionality"
    fi
fi

# Setup PATH in all shell configs
for rc_file in ~/.bashrc ~/.zshrc ~/.profile; do
    if [ -f "$rc_file" ] || [ "$rc_file" = ~/.bashrc ]; then
        if ! grep -q "CI Package Manager" "$rc_file" 2>/dev/null; then
            echo "" >> "$rc_file"
            echo "# CI Package Manager - Universal Launcher" >> "$rc_file"
            echo 'export PATH="$HOME/.local/bin:$HOME/.ci/bin:$PATH"' >> "$rc_file"
        fi
    fi
done

# Add to current session
export PATH="$HOME/.local/bin:$HOME/.ci/bin:$PATH"

echo ""
echo "üéâ COMPLETE CI PACKAGE MANAGER INSTALLED!"
echo "========================================"
echo ""
echo "üöÄ WHAT YOU CAN DO NOW:"
echo "   ci install <package>     # Install any package"
echo "   <package-name>           # Type the name to launch it!"
echo "   ci list                  # See all available commands"
echo "   ci status                # System status"
echo ""
echo "üåü EXAMPLES:"
echo "   ci install hello-ci      # Install a package"
echo "   hello-ci                 # Launch it by typing the name!"
echo "   hello-ci --help          # With arguments!"
echo "   hello-ci anything        # Pass any arguments!"
echo ""
echo "üí° The system automatically creates launchers for ANY package!"
echo "   Just type the package name and it runs!"
EOF

chmod +x install-ci
./install-ci
