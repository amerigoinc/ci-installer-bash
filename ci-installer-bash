#!/bin/bash
# Complete CI Package Manager Installation for AmerigoInc
# This installs EVERYTHING and makes it work immediately

set -e

echo "üåç COMPLETE CI Package Manager Installation"
echo "=========================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print status
status() {
    echo -e "${BLUE}==>${NC} $1"
}

success() {
    echo -e "${GREEN}‚úÖ${NC} $1"
}

warning() {
    echo -e "${YELLOW}‚ö†Ô∏è${NC} $1"
}

error() {
    echo -e "${RED}‚ùå${NC} $1"
}

# Check if git is installed
if ! command -v git &> /dev/null; then
    error "Git is required but not installed."
    echo "Install git first:"
    echo "  Ubuntu/Debian: sudo apt install git"
    echo "  macOS: brew install git"
    echo "  Or download from: https://git-scm.com/"
    exit 1
fi

status "Creating CI directory structure..."
mkdir -p ~/.ci/packages ~/.ci/bin ~/.ci/tmp ~/.ci/config
success "Created CI directories"

status "Creating the complete CI manager..."
cat > ~/.ci/ci-manager << 'EOF'
#!/bin/bash
# Complete CI Package Manager for AmerigoInc
# Handles installation, management, and execution

CI_DIR="$HOME/.ci"
PACKAGES_DIR="$CI_DIR/packages"
BIN_DIR="$CI_DIR/bin"
CONFIG_FILE="$CI_DIR/config/settings.json"
ORG="amerigoinc"

# Load configuration
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source <(jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' "$CONFIG_FILE" 2>/dev/null || echo "")
    fi
}

# Save configuration
save_config() {
    mkdir -p "$(dirname "$CONFIG_FILE")"
    local config="{}"
    if [ -f "$CONFIG_FILE" ]; then
        config=$(cat "$CONFIG_FILE")
    fi
    echo "$config" | jq ".$1=$2" > "$CONFIG_FILE"
}

# Show help
show_help() {
    echo "üåç CI Package Manager - AmerigoInc"
    echo "Usage: ci <command> [options]"
    echo ""
    echo "Commands:"
    echo "  install <package>    Install package from amerigoinc"
    echo "  remove <package>     Remove installed package"
    echo "  list                 List all installed packages"
    echo "  update <package>     Update specific package"
    echo "  update-all           Update all installed packages"
    echo "  info <package>       Show package information"
    echo "  search <term>        Search for packages (placeholder)"
    echo "  clean                Remove temporary files"
    echo "  status               Show CI system status"
    echo "  help                 Show this help message"
    echo ""
    echo "Examples:"
    echo "  ci install image-tools"
    echo "  ci list"
    echo "  ci update-all"
    echo "  ci status"
    echo ""
    echo "Packages from: https://github.com/amerigoinc"
}

# Show system status
show_status() {
    echo "üîß CI Package Manager Status"
    echo "=========================="
    echo "CI Directory: $CI_DIR"
    echo "Packages: $PACKAGES_DIR"
    echo "Binaries: $BIN_DIR"
    echo "Organization: $ORG"
    echo ""
    
    if [ -d "$PACKAGES_DIR" ] && [ "$(ls -A $PACKAGES_DIR 2>/dev/null)" ]; then
        local count=$(ls -1 "$PACKAGES_DIR" | wc -l)
        echo "üì¶ Installed packages: $count"
    else
        echo "üì¶ Installed packages: 0"
    fi
    
    if [ -d "$BIN_DIR" ] && [ "$(ls -A $BIN_DIR 2>/dev/null)" ]; then
        local bin_count=$(ls -1 "$BIN_DIR" | wc -l)
        echo "üîó Available commands: $bin_count"
    else
        echo "üîó Available commands: 0"
    fi
    
    echo ""
    echo "üåê Package source: https://github.com/$ORG"
}

# List installed packages
list_packages() {
    echo "üì¶ Installed Packages from AmerigoInc:"
    echo "======================================"
    
    if [ ! -d "$PACKAGES_DIR" ] || [ -z "$(ls -A $PACKAGES_DIR 2>/dev/null)" ]; then
        echo "No packages installed."
        echo ""
        echo "To install a package:"
        echo "  ci install <package-name>"
        return
    fi
    
    for pkg in "$PACKAGES_DIR"/*; do
        if [ -d "$pkg" ]; then
            pkg_name=$(basename "$pkg")
            echo ""
            echo "üî∏ $pkg_name"
            
            # Show package info from spec.ci if available
            if [ -f "$pkg/spec.ci" ]; then
                local desc=$(grep '"description"' "$pkg/spec.ci" | cut -d'"' -f4 2>/dev/null || echo "No description")
                local version=$(grep '"version"' "$pkg/spec.ci" | cut -d'"' -f4 2>/dev/null || echo "Unknown")
                echo "   üìù $desc"
                echo "   üè∑Ô∏è  Version: $version"
                
                # Show available commands
                main_files=$(grep -o '"main_files":\[[^]]*\]' "$pkg/spec.ci" 2>/dev/null | grep -o '"[^"]*"' | tr -d '"' | tr ',' ' ' || echo "")
                if [ -n "$main_files" ]; then
                    echo "   üöÄ Commands:"
                    for file in $main_files; do
                        if [ -f "$BIN_DIR/$file" ]; then
                            echo "      ‚ñ™ $file"
                        fi
                    done
                fi
            fi
        fi
    done
}

# Install a package
install_package() {
    local pkg="$1"
    if [ -z "$pkg" ]; then
        echo "‚ùå Please specify a package name"
        echo "   Usage: ci install <package>"
        return 1
    fi
    
    echo "üîß Installing: $pkg"
    echo "üåê From: https://github.com/$ORG/$pkg"
    
    local repo_url="https://github.com/$ORG/$pkg.git"
    local pkg_dir="$PACKAGES_DIR/$pkg"
    
    # Check if already installed
    if [ -d "$pkg_dir" ]; then
        echo "üîÑ Package already exists. Updating..."
        update_package "$pkg"
        return $?
    fi
    
    # Clone repository
    echo "üì• Cloning repository..."
    if git clone "$repo_url" "$pkg_dir" 2>&1; then
        echo "‚úÖ Repository cloned successfully"
    else
        echo "‚ùå Failed to clone repository"
        echo "   Check if the package exists: https://github.com/$ORG/$pkg"
        return 1
    fi
    
    # Verify it's a CI package
    if [ ! -f "$pkg_dir/spec.ci" ]; then
        echo "‚ùå Not a valid CI package (missing spec.ci)"
        echo "   Repository must contain a spec.ci file"
        rm -rf "$pkg_dir"
        return 1
    fi
    
    # Process the package
    process_package "$pkg_dir"
    
    echo ""
    echo "üéâ Package '$pkg' installed successfully!"
    show_package_usage "$pkg_dir"
}

# Process package after installation
process_package() {
    local pkg_dir="$1"
    local pkg_name=$(basename "$pkg_dir")
    
    echo "üõ†Ô∏è  Processing package: $pkg_name"
    
    # Make main files executable and create symlinks
    if [ -f "$pkg_dir/spec.ci" ]; then
        # Extract main_files from spec.ci
        main_files=$(grep -o '"main_files":\[[^]]*\]' "$pkg_dir/spec.ci" 2>/dev/null | grep -o '"[^"]*"' | tr -d '"' | tr ',' ' ' || echo "")
        
        for file in $main_files; do
            if [ -f "$pkg_dir/$file" ]; then
                # Make executable
                chmod +x "$pkg_dir/$file"
                echo "   ‚úÖ Made executable: $file"
                
                # Create symlink
                ln -sf "$pkg_dir/$file" "$BIN_DIR/$file"
                echo "   üîó Created command: $file"
            else
                echo "   ‚ö†Ô∏è  Warning: Main file not found - $file"
            fi
        done
    fi
    
    # Run setup if setup.json exists
    if [ -f "$pkg_dir/setup.json" ]; then
        echo "   ‚öôÔ∏è  Running setup commands..."
        run_setup "$pkg_dir"
    fi
}

# Run setup commands
run_setup() {
    local pkg_dir="$1"
    
    if command -v jq >/dev/null 2>&1; then
        local commands=$(jq -r '.post_install[]?' "$pkg_dir/setup.json" 2>/dev/null)
        while IFS= read -r cmd; do
            if [ -n "$cmd" ]; then
                echo "     üõ†Ô∏è  Running: $cmd"
                (cd "$pkg_dir" && eval "$cmd") || echo "       ‚ö†Ô∏è  Command failed: $cmd"
            fi
        done <<< "$commands"
    else
        echo "     ‚ÑπÔ∏è  jq not installed, skipping setup commands"
    fi
}

# Show package usage after installation
show_package_usage() {
    local pkg_dir="$1"
    local pkg_name=$(basename "$pkg_dir")
    
    if [ -f "$pkg_dir/spec.ci" ]; then
        main_files=$(grep -o '"main_files":\[[^]]*\]' "$pkg_dir/spec.ci" 2>/dev/null | grep -o '"[^"]*"' | tr -d '"' | tr ',' ' ' || echo "")
        
        if [ -n "$main_files" ]; then
            echo "üöÄ Now available globally:"
            for file in $main_files; do
                if [ -f "$BIN_DIR/$file" ]; then
                    echo "   üíª $file"
                fi
            done
            echo ""
            echo "Use these commands anywhere in your system!"
        fi
    fi
}

# Remove a package
remove_package() {
    local pkg="$1"
    if [ -z "$pkg" ]; then
        echo "‚ùå Please specify a package name"
        echo "   Usage: ci remove <package>"
        return 1
    fi
    
    local pkg_dir="$PACKAGES_DIR/$pkg"
    
    if [ ! -d "$pkg_dir" ]; then
        echo "‚ùå Package '$pkg' not found"
        return 1
    fi
    
    echo "üóëÔ∏è  Removing package: $pkg"
    
    # Remove symlinks
    if [ -f "$pkg_dir/spec.ci" ]; then
        main_files=$(grep -o '"main_files":\[[^]]*\]' "$pkg_dir/spec.ci" 2>/dev/null | grep -o '"[^"]*"' | tr -d '"' | tr ',' ' ' || echo "")
        
        for file in $main_files; do
            if [ -f "$BIN_DIR/$file" ]; then
                rm -f "$BIN_DIR/$file"
                echo "   üîó Removed command: $file"
            fi
        done
    fi
    
    # Remove package directory
    rm -rf "$pkg_dir"
    echo "‚úÖ Package '$pkg' removed successfully"
}

# Update a package
update_package() {
    local pkg="$1"
    if [ -z "$pkg" ]; then
        echo "‚ùå Please specify a package name"
        echo "   Usage: ci update <package>"
        return 1
    fi
    
    local pkg_dir="$PACKAGES_DIR/$pkg"
    
    if [ ! -d "$pkg_dir" ]; then
        echo "‚ùå Package '$pkg' not found"
        return 1
    fi
    
    echo "üîÑ Updating package: $pkg"
    
    # Update via git
    if (cd "$pkg_dir" && git pull --ff-only 2>&1); then
        echo "‚úÖ Package '$pkg' updated successfully"
        # Re-process package to update symlinks
        process_package "$pkg_dir"
    else
        echo "‚ùå Failed to update package '$pkg'"
        return 1
    fi
}

# Update all packages
update_all_packages() {
    echo "üîÑ Updating all packages..."
    
    if [ ! -d "$PACKAGES_DIR" ] || [ -z "$(ls -A $PACKAGES_DIR 2>/dev/null)" ]; then
        echo "‚ùå No packages installed"
        return 1
    fi
    
    local updated=0
    local failed=0
    
    for pkg in "$PACKAGES_DIR"/*; do
        if [ -d "$pkg" ]; then
            pkg_name=$(basename "$pkg")
            if update_package "$pkg_name"; then
                ((updated++))
            else
                ((failed++))
            fi
            echo ""
        fi
    done
    
    echo "üìä Update complete:"
    echo "   ‚úÖ Updated: $updated"
    echo "   ‚ùå Failed: $failed"
}

# Show package information
package_info() {
    local pkg="$1"
    if [ -z "$pkg" ]; then
        echo "‚ùå Please specify a package name"
        echo "   Usage: ci info <package>"
        return 1
    fi
    
    local pkg_dir="$PACKAGES_DIR/$pkg"
    
    if [ ! -d "$pkg_dir" ]; then
        echo "‚ùå Package '$pkg' not found"
        return 1
    fi
    
    echo "üìã Package Information: $pkg"
    echo "========================"
    
    if [ -f "$pkg_dir/spec.ci" ]; then
        echo "Specification:"
        cat "$pkg_dir/spec.ci"
        echo ""
    fi
    
    echo "Location: $pkg_dir"
    echo ""
    
    if [ -f "$pkg_dir/README.md" ]; then
        echo "README:"
        head -20 "$pkg_dir/README.md"
    fi
}

# Search for packages (basic implementation)
search_packages() {
    local term="$1"
    echo "üîç Search functionality"
    echo "======================"
    echo "Search term: ${term:-'(all packages)'}"
    echo ""
    echo "üåê Visit https://github.com/$ORG to browse available packages"
    echo ""
    echo "Installed packages:"
    list_packages
}

# Clean temporary files
clean_files() {
    echo "üßπ Cleaning temporary files..."
    if [ -d "$CI_DIR/tmp" ]; then
        rm -rf "$CI_DIR/tmp"/*
        echo "‚úÖ Temporary files cleaned"
    else
        echo "‚ÑπÔ∏è  No temporary files found"
    fi
}

# Main command handler
case "${1:-}" in
    install)
        install_package "${2:-}"
        ;;
    remove|uninstall)
        remove_package "${2:-}"
        ;;
    list|ls)
        list_packages
        ;;
    update)
        update_package "${2:-}"
        ;;
    update-all)
        update_all_packages
        ;;
    info)
        package_info "${2:-}"
        ;;
    search)
        search_packages "${2:-}"
        ;;
    clean)
        clean_files
        ;;
    status)
        show_status
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        show_help
        ;;
    *)
        echo "‚ùå Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
EOF

success "Created CI manager script"

status "Making CI manager executable..."
chmod +x ~/.ci/ci-manager
success "Made CI manager executable"

status "Installing CI command system-wide..."
# Try multiple installation locations
INSTALLED=false

if command -v sudo >/dev/null 2>&1; then
    if sudo ln -sf ~/.ci/ci-manager /usr/local/bin/ci 2>/dev/null; then
        success "Installed to /usr/local/bin/ci (system-wide)"
        INSTALLED=true
    fi
fi

if [ "$INSTALLED" = false ]; then
    mkdir -p ~/.local/bin
    if ln -sf ~/.ci/ci-manager ~/.local/bin/ci 2>/dev/null; then
        success "Installed to ~/.local/bin/ci (user-local)"
        INSTALLED=true
    fi
fi

if [ "$INSTALLED" = false ]; then
    if ln -sf ~/.ci/ci-manager ~/bin/ci 2>/dev/null; then
        success "Installed to ~/bin/ci"
        INSTALLED=true
    fi
fi

if [ "$INSTALLED" = false ]; then
    error "Could not install CI command automatically"
    echo "You can still run it directly with: ~/.ci/ci-manager"
fi

status "Setting up shell integration..."
# Function to add to shell config
setup_shell_config() {
    local shell_rc="$1"
    local content="$2"
    
    if [ -f "$shell_rc" ] || [ "$shell_rc" = "$HOME/.bashrc" ]; then
        if ! grep -q "CI Package Manager" "$shell_rc" 2>/dev/null; then
            echo "" >> "$shell_rc"
            echo "# CI Package Manager - AmerigoInc" >> "$shell_rc"
            echo "$content" >> "$shell_rc"
            echo "üìù Added to $shell_rc"
        fi
    fi
}

# Add CI bin to PATH
PATH_LINES="export PATH=\"\$HOME/.ci/bin:\$PATH\""
if [ -d "$HOME/.local/bin" ]; then
    PATH_LINES="export PATH=\"\$HOME/.local/bin:\$HOME/.ci/bin:\$PATH\""
fi

setup_shell_config "$HOME/.bashrc" "$PATH_LINES"
setup_shell_config "$HOME/.zshrc" "$PATH_LINES"
setup_shell_config "$HOME/.profile" "$PATH_LINES"

status "Creating initial configuration..."
cat > ~/.ci/config/settings.json << EOF
{
    "organization": "amerigoinc",
    "version": "1.0.0",
    "install_date": "$(date -Iseconds)",
    "auto_update": true
}
EOF
success "Created configuration"

status "Finalizing installation..."
# Add to current session PATH
export PATH="$HOME/.local/bin:$HOME/.ci/bin:$PATH"

success "COMPLETE installation finished!"
echo ""
echo "üéâ CI Package Manager is now ready!"
echo "==================================="
echo ""
echo "üîß Available commands:"
echo "   ci install <package>    - Install from amerigoinc"
echo "   ci list                 - Show installed packages"
echo "   ci update-all           - Update everything"
echo "   ci remove <package>     - Remove package"
echo "   ci status               - System status"
echo "   ci help                 - Full help"
echo ""
echo "üåê Packages source: https://github.com/amerigoinc"
echo ""
echo "üöÄ To use immediately in this terminal:"
echo "   export PATH=\"\$HOME/.local/bin:\$HOME/.ci/bin:\$PATH\""
echo ""
echo "üîÅ For all future terminals, restart your session."
echo ""
echo "üí° Try: ci status  (to verify installation)"
echo ""
